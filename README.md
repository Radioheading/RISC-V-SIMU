# RISC-V Simulator 2023

这是上海交通大学ACM班2022-2023学年夏季学期的第一个大作业。

本项目用C++实现了一个用Tomasulo架构的CPU模拟器，各模块（取指令、解析指令、计算、更新、发射、提交）之间支持乱序执行。

同时，本项目实现了分支预测，提高了CPU性能。

## 架构图

使用 Tomasulo 算法模拟 CPU 执行指令。设计的电路图如下：

![structure](\\wsl.localhost\Ubuntu\home\brucelee\PPCA\RISC-V-SIMU\structure.jpg)

## 分支预测

使用 127（2的幂次附近，为素数）个二位饱和计数器。

对于一条分支指令，我们对它的地址(cur_pc)进行取模，并进行分支预测，下表给出了预测成功率，较为符合预期。

| 测试点         | 分支总数 | 成功预测数 | 预测成功率 |
| -------------- | :------: | :--------: | :--------: |
| array_test1    |    22    |     12     |   54.55%   |
| array_test2    |    26    |     15     |   57.69%   |
| basicopt1      |  155139  |   127840   |   82.40%   |
| bulgarian      |  71439   |   67527    |   94.52%   |
| expr           |   111    |     94     |   84.68%   |
| gcd            |   120    |     81     |   67.50%   |
| hanoi          |  17457   |   10667    |   61.10%   |
| lvalue2        |    6     |     4      |   66.67%   |
| magic          |  67869   |   53222    |   78.42%   |
| manyarguments  |    10    |     6      |   60.00%   |
| multiarray     |   162    |    135     |   83.33%   |
| naive          |    0     |     0      |    NaN     |
| pi             | 39956380 |  32925340  |   82.40%   |
| qsort          |  200045  |   174888   |   87.42%   |
| queens         |  77116   |   56587    |   73.38%   |
| statement_test |   202    |    122     |   60.40%   |
| superloop      |  435027  |   408156   |   93.82%   |
| tak            |  60639   |   44755    |   73.81%   |

下面给出了本项目在各数据下有分支预测和无分支预测时分别需要的时钟周期数。

| 测试点         | 分支总数 | 时钟周期数（含分支预测） | 时钟周期数 | 效率提升 |
| -------------- | :------: | :----------------------: | ---------- | :------: |
| array_test1    |    22    |           328            | 354        |  7.93%   |
| array_test2    |    26    |           375            | 427        |  13.87%  |
| basicopt1      |  155139  |          831764          | 1263220    |  51.87%  |
| bulgarian      |  71439   |          572818          | 917494     |  60.17%  |
| expr           |   111    |           983            | 1293       |  31.54%  |
| gcd            |   120    |           727            | 974        |  33.98%  |
| hanoi          |  17457   |          384236          | 432539     |  12.57%  |
| lvalue2        |    6     |            66            | 80         |  21.21%  |
| magic          |  67869   |         1062450          | 1370425    |  28.99%  |
| manyarguments  |    10    |            81            | 103        |  27.16%  |
| multiarray     |   162    |           3251           | 3707       |  14.03%  |
| naive          |    0     |            39            | 39         |    0%    |
| pi             | 39956380 |        162584838         | 262542907  |  61.48%  |
| qsort          |  200045  |         1947783          | 3182572    |  63.39%  |
| queens         |  77116   |         1082378          | 1369964    |  26.57%  |
| statement_test |   202    |           1729           | 2166       |  25.27%  |
| superloop      |  435027  |          786559          | 1972050    | 150.72%  |
| tak            |  60639   |         3646962          | 3871537    |  6.16%   |
